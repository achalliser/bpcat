<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–î–Ω–µ–≤–Ω–∏–∫ –¥–∞–≤–ª–µ–Ω–∏—è ‚Äî –ø–∏—Ç–æ–º—Ü—ã</title>
<style>
  :root{--accent:#4B807B;--danger:#FF6B6B;--muted:#666}
  body{font-family:Inter, Arial, sans-serif;margin:0;background:#FBFAF9;color:#222;padding:18px}
  .wrap{max-width:980px;margin:0 auto}
  header{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{margin:0;color:var(--accent)}
  .pets{margin-left:auto;display:flex;gap:8px;align-items:center}
  select,input[type="text"]{padding:6px;border-radius:8px;border:1px solid #ddd}
  button{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;color:var(--accent);border:1px solid #dfeee9}
  button.danger{background:var(--danger)}
  main{margin-top:18px;display:grid;grid-template-columns:1fr 320px;gap:18px}
  .card{background:#fff;border-radius:12px;padding:12px;border:1px solid #eee;box-shadow:0 6px 18px rgba(20,20,20,0.04)}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px;border-bottom:1px dashed #eee;text-align:center}
  th{background:#fafafa;color:var(--muted)}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .corner-print{position:fixed;right:18px;bottom:18px;background:var(--accent);color:#fff;padding:10px;border-radius:999px;box-shadow:0 6px 20px rgba(0,0,0,0.12);cursor:pointer;border:none}
  .small{font-size:13px;color:var(--muted)}
  .delete-btn{background:#FF8C8C;border:none;padding:6px 8px;border-radius:8px;cursor:pointer;color:#fff}
  @media(max-width:900px){main{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>–î–Ω–µ–≤–Ω–∏–∫ –¥–∞–≤–ª–µ–Ω–∏—è</h1>
      <div class="small">–í–µ–¥–∏—Ç–µ –∑–∞–ø–∏—Å–∏ –ø–æ —Ä–∞–∑–Ω—ã–º –ø–∏—Ç–æ–º—Ü–∞–º ‚Äî –∫–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ.</div>
    </div>

    <div class="pets">
      <label class="small" for="petSelect">–ü–∏—Ç–æ–º–µ—Ü</label>
      <select id="petSelect"></select>
      <input type="text" id="newPetName" placeholder="–ù–æ–≤–æ–µ –∏–º—è –ø–∏—Ç–æ–º—Ü–∞">
      <button id="addPetBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button class="ghost" id="openPageBtn" title="–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ">–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
      <button class="ghost" id="deletePetBtn" title="–£–¥–∞–ª–∏—Ç—å –ø–∏—Ç–æ–º—Ü–∞">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </header>

  <main>
    <section>
      <div class="card">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <input type="date" id="date">
          <input type="time" id="time">
          <input type="number" id="syst" placeholder="–°–∏—Å—Ç" style="width:86px">
          <input type="number" id="diast" placeholder="–î–∏–∞—Å—Ç" style="width:86px">
          <input type="number" id="pulse" placeholder="–ü—É–ª—å—Å" style="width:86px">
          <input type="text" id="pose" placeholder="–ø–æ–∑–∞" style="width:120px">
        </div>

        <div style="margin-top:8px">
          <input type="text" id="notes" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è" style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee">
        </div>

        <div class="actions">
          <button onclick="addEntry()">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
          <button class="danger" onclick="clearEntries()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏</button>
        </div>

        <hr style="margin:12px 0">

        <table id="entriesTable" aria-live="polite">
          <thead>
            <tr><th>–î–∞—Ç–∞</th><th>–í—Ä–µ–º—è</th><th>–°–∏—Å—Ç./–î–∏–∞—Å—Ç.</th><th>–ü—É–ª—å—Å</th><th>–ü–æ–∑–∞</th><th>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</th><th>–£–¥–∞–ª–∏—Ç—å</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <aside>
      <div class="card">
        <div class="small">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–∏—Ç–æ–º—Ü–∞)</div>
        <div id="stats" style="margin-top:10px;font-weight:700">‚Äî</div>
        <hr style="margin:12px 0">
     <div class="small">–ú–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã / –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</div>
<textarea id="meds" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏–ª–∏ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞..." 
          style="margin-top:8px;width:100%;height:60px;resize:none;
                 border:1px solid #ccc;border-radius:6px;padding:6px;
                 font-family:inherit;"></textarea>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div class="small">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</div>
        <ul style="padding-left:18px;margin-top:8px">
          <li class="small">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –≤–µ—Ä–Ω–æ –ª–∏ –≤—ã–±—Ä–∞–Ω –ø—Ä–æ—Ñ–∏–ª—å –ø–∏—Ç–æ–º—Ü–∞.</li>
          <li class="small">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–æ–¥–∏—Ç—å –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –≤—Ä–µ–º—è.</li>
          <li class="small">–ú–æ–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –ø–æ–∑—É –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–∏—Ç–æ–º—Ü–∞.</li>
          <li class="small">–ü—Ä–∏ —Ä–µ–∑–∫–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π ‚Äî —Å—Ä–æ—á–Ω–æ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä–æ–º.</li>
          <li class="small">–í –Ω–∏–∂–Ω–µ–º –ø—Ä–∞–≤–æ–º —É–≥–ª—É —Å—Ç—Ä—É–Ω–∏—Ü—ã –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ –ø–µ—á–∞—Ç–∏ PDF —Ñ–∞–π–ª–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã</li>
        </ul>
      </div>
    </aside>
  </main>
</div>

<button class="corner-print" onclick="window.print()">üñ® –ü–µ—á–∞—Ç—å / PDF</button>

<script>
/* ---------- Helpers ---------- */
function slugify(s){ return String(s).trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'').slice(0,40) || 'pet'; }
function storageKeyFor(slug){ return 'catBP_' + slug; }

/* ---------- Pets management ---------- */
let pets = []; // array of {name, slug}
const petSelect = document.getElementById('petSelect');
const newPetName = document.getElementById('newPetName');

function loadPets(){
  pets = JSON.parse(localStorage.getItem('catBP_pets') || '[]');
  renderPetOptions();
  let hash = location.hash.match(/#pet=([^&]+)/);
  if(hash){
    const slug = decodeURIComponent(hash[1]);
    if(!pets.find(p=>p.slug===slug)){
      // –µ—Å–ª–∏ –≤ —Ö—ç—à–µ –ø–∏—Ç–æ–º—Ü–∞ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ ‚Äî –¥–æ–±–∞–≤–∏–º –∑–∞–≥–ª—É—à–∫—É
      pets.push({name: slug.replace(/-/g,' '), slug});
      savePets();
    }
    selectPet(slug);
  } else {
    if(pets.length===0){
      // —Å–æ–∑–¥–∞—ë–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ –ø–∏—Ç–æ–º—Ü–∞
      const defaultName = '–ú—É—Ä—á–∏–∫';
      addPet(defaultName, true);
    } else {
      selectPet(pets[0].slug);
    }
  }
}
function savePets(){ localStorage.setItem('catBP_pets', JSON.stringify(pets)); }
function renderPetOptions(){
  petSelect.innerHTML = '';
  pets.forEach(p=> {
    const opt = document.createElement('option');
    opt.value = p.slug; opt.textContent = p.name;
    petSelect.appendChild(opt);
  });
}
document.getElementById('addPetBtn').addEventListener('click', ()=> {
  const name = newPetName.value.trim();
  if(!name){ alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–∏—Ç–æ–º—Ü–∞'); return; }
  addPet(name);
  newPetName.value = '';
});
function addPet(name, silent){
  const slug = slugify(name) + '-' + Date.now().toString().slice(-4);
  pets.push({name, slug});
  savePets();
  renderPetOptions();
  selectPet(slug);
  if(!silent) alert('–ü–∏—Ç–æ–º–µ—Ü –¥–æ–±–∞–≤–ª–µ–Ω ‚Äî –º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å –≤–µ—Å—Ç–∏ –∑–∞–ø–∏—Å–∏.');
}
document.getElementById('deletePetBtn').addEventListener('click', ()=>{
  const slug = petSelect.value;
  if(!slug) return;
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–∏—Ç–æ–º—Ü–∞ –∏ –≤—Å–µ –µ–≥–æ –∑–∞–ø–∏—Å–∏?')) return;
  // —É–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
  localStorage.removeItem(storageKeyFor(slug));
  pets = pets.filter(p=>p.slug!==slug);
  savePets();
  renderPetOptions();
  if(pets.length) selectPet(pets[0].slug); else addPet('–ú—É—Ä—á–∏–∫', true);
});

/* ---------- Open pet page (hash) ---------- */
document.getElementById('openPageBtn').addEventListener('click', ()=> {
  const slug = petSelect.value;
  const url = location.origin + location.pathname + '#pet=' + encodeURIComponent(slug);
  window.open(url, '_blank');
});

/* ---------- Entries management (per-pet) ---------- */
let currentPet = null;
const entriesTbody = document.querySelector('#entriesTable tbody');

petSelect.addEventListener('change', ()=> selectPet(petSelect.value));

function selectPet(slug){
  currentPet = pets.find(p=>p.slug===slug) || null;
  if(!currentPet) return;
  petSelect.value = currentPet.slug;
  // update url hash but don't reload
  location.hash = 'pet=' + encodeURIComponent(currentPet.slug);
  loadEntries();
  renderStats();
}

function loadEntries(){
  if(!currentPet) return;
  const data = JSON.parse(localStorage.getItem(storageKeyFor(currentPet.slug)) || '[]');
  entriesTbody.innerHTML = '';
  data.forEach((e,i)=>{
    const tr = document.createElement('tr');
    const systDiast = (e.syst || '') + (e.syst||e.diast ? ' / ' : '') + (e.diast || '');
    tr.innerHTML = `<td>${e.date||''}</td>
                    <td>${e.time||''}</td>
                    <td>${systDiast}</td>
                    <td>${e.pulse||''}</td>
                    <td>${e.pose||''}</td>
                    <td style="text-align:left;padding-left:12px">${e.notes||''}</td>
                    <td><button class="delete-btn" onclick="deleteEntry(${i})" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å">‚úñ</button></td>`;
    entriesTbody.appendChild(tr);
  });
  renderStats();
}

function saveEntries(arr){
  if(!currentPet) return;
  localStorage.setItem(storageKeyFor(currentPet.slug), JSON.stringify(arr));
}

function addEntry(){
  if(!currentPet){ alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–∏—Ç–æ–º—Ü–∞'); return; }
  const entry = {
    date: document.getElementById('date').value,
    time: document.getElementById('time').value,
    syst: document.getElementById('syst').value,
    diast: document.getElementById('diast').value,
    pulse: document.getElementById('pulse').value,
    pose: document.getElementById('pose').value,
    notes: document.getElementById('notes').value
  };
  if(!entry.date || !entry.time){ alert('–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è'); return; }
  const arr = JSON.parse(localStorage.getItem(storageKeyFor(currentPet.slug)) || '[]');
  arr.push(entry);
  saveEntries(arr);
  loadEntries();
  // –æ—á–∏—Å—Ç–∏–º –ø–æ–ª—è –∫—Ä–æ–º–µ pet selector
  ['date','time','syst','diast','pulse','pose','notes'].forEach(id=>document.getElementById(id).value='');
}

function deleteEntry(index){
  if(!currentPet) return;
  if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) return;
  const arr = JSON.parse(localStorage.getItem(storageKeyFor(currentPet.slug)) || '[]');
  arr.splice(index,1);
  saveEntries(arr);
  loadEntries();
}

function clearEntries(){
  if(!currentPet) return;
  if(!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ —É —Ç–µ–∫—É—â–µ–≥–æ –ø–∏—Ç–æ–º—Ü–∞?')) return;
  localStorage.removeItem(storageKeyFor(currentPet.slug));
  loadEntries();
}

/* ---------- Stats ---------- */
function renderStats(){
  if(!currentPet){ document.getElementById('stats').textContent='‚Äî'; return; }
  const arr = JSON.parse(localStorage.getItem(storageKeyFor(currentPet.slug)) || '[]');
  if(arr.length===0){ document.getElementById('stats').textContent='–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π'; return; }
  // —Å—á–∏—Ç–∞–µ–º —Å—Ä–µ–¥–Ω–∏–µ (–ø—Ä–æ—Å—Ç–∞—è –∞—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–µ)
  let sumS=0, sumD=0, sumP=0, cntS=0, cntD=0, cntP=0;
  arr.forEach(x=>{
    const s = parseFloat(x.syst); const d = parseFloat(x.diast); const p = parseFloat(x.pulse);
    if(!isNaN(s)){ sumS+=s; cntS++; }
    if(!isNaN(d)){ sumD+=d; cntD++; }
    if(!isNaN(p)){ sumP+=p; cntP++; }
  });
  const avgS = cntS?Math.round(sumS/cntS):'‚Äî';
  const avgD = cntD?Math.round(sumD/cntD):'‚Äî';
  const avgP = cntP?Math.round(sumP/cntP):'‚Äî';
  document.getElementById('stats').textContent = `–°—Ä–µ–¥–Ω–µ–µ: ${avgS} / ${avgD}   ¬∑   –ü—É–ª—å—Å: ${avgP} —É–¥/–º–∏–Ω   ¬∑   –ó–∞–ø–∏—Å–µ–π: ${arr.length}`;
}

/* ---------- Init ---------- */
loadPets();
</script>
</body>
</html>
